---
title: "Predicting IUCN Red List status of fish in Hawaii"
description: "In this post, I investigate Hawaiian fish ecological traits – such as size, endemism, and reef-association – to find their probability of being threatened as ranked by the IUCN Red List."
author:
  - name: Elke Windschitl
    url: https://elkewind.github.io
    affiliation: UCSB Bren School
    affiliation-url: http://ucsb-meds.github.io
date: 2022-12-02
categories: [MEDS, Statistics]
citation: 
  url: https://elkewind.github.io/posts/2022-12-02-hawaiian-fish-analysis
image: (put image in folder)
draft: false
---

```{r}
#| include: false
### ------------------- EDS 222 Final Project ------------------- ###
### Identifying key traits in Hawaiian fish to predict risk of extinction ###
# Load libraries
library(rfishbase)
library(tidyverse)
library(janitor)
library(jsonlite)
library(rredlist)
library(broom)
library(sjPlot)
# Set data export location
datadir <- "/Users/elkewindschitl/Documents/MEDS/eds-222/final-proj/data"
### ------------------------ Stats Analysis ------------------------  ###
tidy_fish_data <- read_csv(file.path(datadir, "hi_tidy_fish_data.csv"))
hi_fish_status <- read_csv(file.path(datadir, "hi_fish_status.csv"))

tidy_fish_data <- tidy_fish_data %>% 
   mutate(is_threatened = case_when(is_of_concern == 1 ~ "yes",
                                     is_of_concern == 0 ~ "no"))
# Here I look at each piece individually, then combine them together later
rm_len_na <- tidy_fish_data %>% 
  filter(!length_cm == "NA")
# Graph length vs is of concern
gg_len <- ggplot(data = rm_len_na, aes(x = length_cm, y = is_of_concern)) +
  geom_jitter(width = 0, height = 0.05, alpha = 0.8, col = "#38b6ba") +
  labs(x = "Species average length", y = "Listed as a concern") +
  theme_minimal()
gg_len
# Log regression length
mod_length <- glm(is_of_concern ~ length_cm, 
                  data = rm_len_na, 
                  family = "binomial")
summary(mod_length)
# Plot with regression
len_data_space <- gg_len +
  geom_smooth(method = "glm", 
              se = FALSE, color = "#545454", 
              method.args = list(family = "binomial"))
len_data_space
# Run this again, but remove large values to evaluate robustness
rm_outliers <- rm_len_na %>% 
  filter(length_cm <= 1000)
# Graph length vs is of concern
gg_rm_out <- ggplot(data = rm_outliers, aes(x = length_cm, y = is_of_concern)) +
  geom_jitter(width = 0, height = 0.05, alpha = 0.8, col = "#38b6ba") +
  labs(x = "Species average length", y = "Listed as a concern") +
  theme_minimal()
gg_rm_out
# Log regression length
mod_rm_out <- glm(is_of_concern ~ length_cm, 
                  data = rm_outliers, 
                  family = "binomial")
summary(mod_rm_out)
# Plot with regression
len_rm_out_plot <- gg_rm_out +
  geom_smooth(method = "glm", 
              se = FALSE, color = "#545454", 
              method.args = list(family = "binomial"))
len_rm_out_plot
# Make bins
len_breaks <- rm_len_na %>%
  pull(length_cm) %>%
  quantile(probs = 0:10/10)

len_binned_space <- len_data_space + 
  stat_summary_bin(
    fun = "mean", color = "red", 
    geom = "line", breaks = len_breaks
  )
len_binned_space
# Compute fitter probabilities, then graph
length_plus <- mod_length %>%
  augment(type.predict = "response") %>%
  mutate(y_hat = .fitted)
ggplot(length_plus, aes(x = length_cm, y = y_hat)) +
  geom_point() +
  geom_line() +
  scale_y_continuous("Probabilities of being threatened", 
                     limits = c(0,1))
# Compute odds scale and graph it
length_plus <- length_plus %>% 
  mutate(odds_hat = y_hat / (1 - y_hat)) %>% 
  filter(length_cm <= 1000) # remove outliers for graphing
len_odds_plot <- ggplot(length_plus, aes(x = length_cm, y = odds_hat)) +
  geom_point() + 
  geom_line() + 
  scale_y_continuous("Odds of being threatened")
len_odds_plot
# Pull B1
len_b1 <- mod_length$coefficients[2]
len_odds_ratio <- exp(len_b1)
print(paste0("The model suggests that each additional cm in length is associated with a ",
             round(len_odds_ratio, 1), "% increase in the odds of being threatened"))
# Compute log-odds and graph it
length_plus <- length_plus %>% 
  mutate(log_odds_hat = log(odds_hat))
ggplot(length_plus, aes(x = length_cm, y = log_odds_hat)) +
  geom_point() + 
  geom_line() + 
  scale_y_continuous("Log(odds) of being threatened")
# Create confusion matrix to see how well the model performed
length_plus <- augment(mod_length, type.predict = "response") %>%
  mutate(threatened_hat = round(.fitted)) %>%
  select(is_of_concern, length_cm, .fitted, threatened_hat)
l_tab <- length_plus %>%
  select(is_of_concern, threatened_hat) %>%
  table()
l_tab
acc <- (l_tab[1,1] + l_tab[2,2]) / nrow(length_plus) * 100
print(paste0("The accuracy of this model was ", round(acc), "%")) 
# Add reef association to the model
tidy_no_na <- rm_len_na %>% 
  filter(!coral_reefs == "NA")
len_reef_mod <- glm(is_of_concern ~ length_cm + reef_associated,
                    data = tidy_no_na,
                    family = "binomial")
len_reef_mod
print(paste0("Fish that are reef associated see their odds of being threatened decrease by a factor of ", -round(len_reef_mod$coefficients[3], 2), " after controlling for length"))
# Create confusion matrix to see how well the model performed
length_reef_plus <- augment(len_reef_mod, type.predict = "response") %>%
  mutate(threatened_hat = round(.fitted)) %>%
  select(is_of_concern, length_cm, reef_associated, .fitted, threatened_hat)
l_r_tab <- length_reef_plus %>%
  select(is_of_concern, threatened_hat) %>%
  table()
l_r_tab # Adding reef did nothing
# Add endemism to the original length model
len_end_mod <- glm(is_of_concern ~ length_cm + is_endemic,
                   data = rm_len_na,
                   family = "binomial")
summary(len_end_mod)
print(paste0("Fish that are endemic see their odds of being threatened increase by a factor of ", round(len_end_mod$coefficients[3], 2), " after controlling for length"))
# Create confusion matrix to see how well the model performed
length_end_plus <- augment(len_end_mod, type.predict = "response") %>%
  mutate(threatened_hat = round(.fitted)) %>%
  select(is_of_concern, length_cm, is_endemic, .fitted, threatened_hat)
l_e_tab <- length_end_plus %>%
  select(is_of_concern, threatened_hat) %>%
  table()
l_e_tab # Adding endemism did nothing
rm_ra_na <- tidy_fish_data %>% 
  filter(!coral_reefs == "NA")
# Plot reef associated vs is of concern 
gg_reef <- ggplot(data = rm_ra_na, aes(x = reef_associated, y = is_of_concern)) +
  geom_jitter(width = 0.05, height = 0.05, alpha = 0.8, col = "#38b6ba") +
  labs(x = "Reef Associated", y = "Listed as a concern") +
  theme_minimal()
gg_reef
# Log regression reefs -- does this even make sense to do?
mod_reef <- glm(is_of_concern ~ reef_associated, 
                data = rm_ra_na, 
                family = "binomial")
summary(mod_reef)
# Plot endemism vs is of concern
gg_status <- ggplot(data = tidy_fish_data, aes(x = is_endemic, y = is_of_concern)) +
  geom_jitter(width = 0.05, height = 0.05, alpha = 0.8, col = "#38b6ba") +
  labs(x = "Endemic", y = "Listed as a concern") +
  theme_minimal()
gg_status
# Log regression of endemism -- does this even make sense to do?
mod_status <- glm(is_of_concern ~ is_endemic, 
                  data = tidy_fish_data, 
                  family = "binomial")
summary(mod_status)
# I don't think these last two are correct... ask!!!
# Combining it all together (even though)
mod <- glm(is_of_concern ~ length_cm + reef_associated + is_endemic,
           data = tidy_no_na,
           family = "binomial")
summary(mod)
# Pull out all coefficients
b0 <- mod$coefficients[1] #Intercept
b1 <- mod$coefficients[2] #Length
b2 <- mod$coefficients[3] #Reef Associated
b3 <- mod$coefficients[4] #Endemic
# Run some test probabilities 
equ <- b0 + b1 * 700  + b2 + b3
p_700_1_1 <- (exp(equ)) / (1 + exp(equ))
equ20 <- b0 + b1 * 20  + b2 + b3
p_20_1_1 <- (exp(equ20)) / (1 + exp(equ20))
equ450 <- b0 + b1 * 450  + b2 + b3
p_450_1_1 <- (exp(equ450)) / (1 + exp(equ450))
# Write a function for testing probabilities
threat_prob <- function(b0, b1, b2, b3, len, reef, end) {
  equ <- b0 + b1 * len + b2 * reef + b3 * end
  prob <- (exp(equ)) / (1 + exp(equ))
  print(prob)
}
# Test
threat_prob(b0, b1, b2, b3, 700, 1, 1)
threat_prob(b0, b1, b2, b3, 20, 1, 1)
threat_prob(b0, b1, b2, b3, 450, 1, 1)
# Attempt some t-tests???
t.test(is_of_concern ~ reef_associated, data = rm_ra_na)
t.test(is_of_concern ~ is_endemic, data = tidy_fish_data)

### ------------------------ Predictions ------------------------  ###

# Filter for all columns of data deficient fish in Hawaii
hi_fish_no_rank <- hi_fish_status %>% 
  filter(is.na(category) | category == "DD")
# Tidy data
tidy_no_rank <- hi_fish_no_rank %>% 
  mutate(coral_reefs = coral_reefs * - 1) %>% 
  mutate(reef_associated = case_when(coral_reefs == 1 ~ "yes",
                                     coral_reefs == 0 ~ "no")) %>% 
  mutate(is_endemic = case_when(status == "endemic" ~ 1,
                                status == "native" |
                                  status == "introduced" ~ 0))
# Create loop to populate prob in every row
for (i in seq_along(tidy_no_rank$genus_species)) {
  tidy_no_rank$y_hat[i] <- threat_prob(b0, b1, b2, b3, 
                                    tidy_no_rank$length_cm[i],
                                    tidy_no_rank$coral_reefs[i],
                                    tidy_no_rank$is_endemic[i])
}
# Arrange by probability 
tidy_pred_rank <- tidy_no_rank %>% arrange(desc(y_hat)) %>% 
  mutate(endemic = case_when(status == "endemic" ~ "yes",
                                status == "native" |
                                status == "introduced" ~ "no"))
```

<h3>Introduction</h3>

Many species in modern times are faced with the risk of extinction due to global human activity. According to the International Union and Conservation of Nature (IUCN), "More than 41,000 species are threatened with extinction. That is still 28% of all assessed species." \[1\]. Increased extinction and loss of biodiversity can have severe ecological, economic, and cultural impacts. Cardinale et al.'s deep dive into biodiversity and ecosystem services research conclude consensus statements that biodiversity loss reduces ecological communities' efficiency, stability, and productivity. Ecosystem services productivity reductions can have a negative impact on ecosystem economics \[2\]. Additionally, cultures worldwide have strong ties to local flora and fauna, much of which now face extinction risk. Improving understanding of extinction risk is ecologically, economically, and culturally important.

Wildlife scientists have been working to understand what ecological traits of vertebrates predict threat level, and what common risk factors drive those threat level rates. Munstermann et al. investigate what terrestrial vertebrate functional groups are most at risk of extinction threat and find that cave dwelling amphibian, arboreal quadrupedal mammals, aerial and scavenging birds, and pedal squamates are at high risk \[3\]. This knowledge can help inform policies and practices with the goal to decrease threats of extinction of wildlife. However, less comprehensive research has been done to conduct similar analyses on marine species.

In recent years, the waters surrounding the Hawaiian Islands have been exposed to ecological changes due to mass coral bleaching events, El Nino events, and pollution. Rapidly changing marine ecosystems may pose a threat to Hawaiian fish. Fish hold significant cultural value in Hawaii, and many local people rely on seafood as a major source of protein. However, approximately 72% of fish in Hawaii present in FishBase have been evaluated by the IUCN and have sufficient data to be assessed. Here I run a small-scale analysis to investigate Hawaiian fish ecological traits -- such as endemism, size, and reef-association -- to predict a binary status on the IUCN red list and predict which unevaluated fish species in Hawaii may be threatened.

<h3>Data</h3>

For my analyses I use the IUCN Red List data accessed via the IUCN Red List API \[1\] and package rredlist \[4\]. Consistent with Munstermann et al., living species listed as 'Vulnerable', 'Endangered', or 'Critically Endangered' were categorized as 'Threatened'. Living species listed as 'Least Concern' and 'Near Threatened' were categorized as 'Nonthreatened' \[3\]. Extinct species were not evaluated in this analysis. The IUCN Red List data are limited in that many marine species have not been listed yet or have been identified as too data deficient to be evaluated. The lack of data on elusive fish may introduce bias into the model.

Fish ecological data were accessed from FishBase \[5\] via package rfishbase \[6\]. Different species in the FishBase data were originally described by different people, possibly leading to errors or biases. Measurement errors in length may be present, as there are various common ways to measure the length of a fish. The species recorded in FishBase may be biased towards fish with commercial value.

<h3>Methods</h3>

Here I run a logistic regression with a categorical binary response variable of 'Threatened' or 'Nonthreatened' on species length, coral reef association, and endemism.

I included length in the model because previous research show that species of extreme sizes have higher risk of extinction. Ripple et al. "found that the probability of being threatened was positively and significantly related to body mass for birds, cartilaginous fishes, and mammals" \[7\]. While body mass is not the same as length, the FishBase data set had few weight entries and many length entries, and sample size was already limited. Several mass coral bleaching events have occurred in Hawaii in recent decades causing ecosystem disruption \[8\]. Here I consider if reef-associated fish are more likely to be threatened that fish that are not reef-associated. Last, endemic species -- species that are native to a region and occur only in that region -- are known to be at high risk of extinction.

<h3>Results & Discussion</h3>

#### Data exploration:

##### 1. Tidy data set:

```{r}
#| echo: false
#| warning: false
tidy_fish_data <- tidy_fish_data %>% 
  select("genus_species", "length_cm", "category", "main_common_name", "reef_associated", "is_endemic", "is_threatened")
```

```{r}
#| echo: false
#| warning: false
#head(tidy_fish_data)
tab_df(tidy_fish_data[1:5,],
       title = "Tbl 1. Hawaii Fish Data",
       col.header = c("Genus species", "Length (cm)", "IUCN Category", 
                          "Common Name", "Reef Association", "Endemic",
                          "Threatened"))
       
```

##### 2. IUCN Red List Threatened Status

```{r}
#| echo: false
#| warning: false
threat_tab <- table(tidy_fish_data$is_threatened)
tab_df(threat_tab,
       title = "Tbl 2. Threatened on IUCN Red List Counts",
       col.header = "Nonthreatened", "Threatened")
```

##### 3. Fish Length

```{r}
#| echo: false
#| warning: false
ggplot(tidy_fish_data, aes(x = length_cm)) +
  geom_histogram(fill = "#38b6ba") + 
  xlab("Length (cm)") +
  ylab("Count") +
  theme_minimal()
```

##### 4. Reef-Association

```{r}
#| echo: false
#| warning: false
reef_tab <- table(tidy_fish_data$reef_associated)
tab_df(threat_tab,
       title = "Tbl 3. Reef Associated Counts")
```

##### 5. Endemism

```{r}
#| echo: false
#| warning: false
end_tab <- table(tidy_fish_data$is_endemic)
tab_df(end_tab,
       title = "Tbl 4. Endemic Counts")
```

After aligning the FishBase data with the IUCN Red List data, the data are disproportionate in both the threat level and endemism.

#### Analysis

**Length** $$\operatorname{logit}(p)=\log \left(\frac{p}{1-p}\right)=\beta_0+\beta_1  (Length)  +\varepsilon $$

```{r}
#| echo: false
#| warning: false
len_data_space
summary(mod_length)
tab_model(mod_length,
          transform = NULL,
          pred.labels = c("Intercept", "Length (cm)"),
          dv.labels = c("log Threat Pobability"),
          show.p = TRUE,
          p.style = c("numeric_stars"),
          p.threshold = c(0.10, 0.05, 0.01),
          string.p = "P-value",
          show.r2 = FALSE,
          title = "Tbl 5. Logisitc Model Results for Length",
          digits = 3)

len_rm_out_plot
#summary(mod_rm_out)
tab_model(mod_rm_out,
          transform = NULL,
          pred.labels = c("Intercept", "Length (cm)"),
          dv.labels = c("log Threat Pobability"),
          show.p = TRUE,
          p.style = c("numeric_stars"),
          p.threshold = c(0.10, 0.05, 0.01),
          string.p = "P-value",
          show.r2 = FALSE,
          title = "Tbl 6. Logisitc Model Results for Length with Outliers Removed",
          digits = 3)
```

```{r}
#| echo: false
#| warning: false
len_odds_plot
```

Here we see that longer fish are associated with higher probability of being threatened (p-value = 2e\^-16), but two outliers may be driving this significance. However, when the outliers are removed, we still see a positive correlation with fish length and probability of threat with the 50% probability mark remaining just over 400 cm (p-value = 2e\^-16). When we compute the odds ratio, we see that there is an exponential relationship between the length and the odds of a species being threatened. Odds of being threatened increase more at large lengths.

Confusion Matrix:

```{r}
#| echo: false
#| warning: false
length_plus <- augment(mod_length, type.predict = "response") %>%
  mutate(threatened_hat = round(.fitted)) %>%
  select(is_of_concern, length_cm, .fitted, threatened_hat)
l_con_matrix <- length_plus %>%
  select(is_of_concern, threatened_hat) %>%
  table()
rownames <- c("Actually Nonthreatened", "Actually Threatend")
colnames <- c("Predicted Nonthreatend", "Predicted Threatened")
l_con_matrix <- as.data.frame(matrix(c(l_con_matrix[1], 
                                       l_con_matrix [2], 
                                       l_con_matrix[3], 
                                       l_con_matrix[4]), 
                                     ncol = 2, 
                                     nrow = 2),
                              row.names = rownames)
colnames(l_con_matrix) <- colnames
tab_df(l_con_matrix,
       title = "Tbl 7. Length Model Confusion Matrix",
       show.rownames = TRUE)
```

The accuracy of the model is 97%, but it seems to be more accurate in predicting species that are not actually of concern (true negative rate = 0.99). Species that are threatened have poorer prediction rates (true positive rate = 0.38).

**Full Model** $$\operatorname{logit}(p)=\log \left(\frac{p}{1-p}\right)=\beta_0+\beta_1  (Length) + \beta_2  (Reef) + \beta_3  (Endemic) +\varepsilon $$

```{r}
#| echo: false
#| warning: false
#summary(mod)
tab_model(mod,
          transform = NULL,
          pred.labels = c("Intercept", "Length (cm)", 
                          "Reef Association", "Endemic"),
          dv.labels = c("log Threat Pobability"),
          p.style = c("numeric_stars"),
          p.threshold = c(0.10, 0.05, 0.01),
          show.p = TRUE,
          string.p = "P-value",
          show.r2 = FALSE,
          title = "Tbl 8. Logisitc Model Results for Length, Reef Association, and Endemism",
          digits = 3)
```

We can see from the output that length remains significant (p-value = 8.83e\^-15) even when additional variables are added, making length robust. Endemicity is significantly influencing the model at alpha = 0.90 (p-value = 0.0707). Coral reef association is not significantly impacting the model (p-value = 0.9175).

#### Predicting Probability -- Solving for p

In this model, the smallest fish in the data set -- *Melamphaes danae* at 2.30 cm -- has a probability of being threatened of 0.012. The largest fish in the data set -- *Rhincodon typus* at 1700 cm -- has a probability of being threatened of 0.99.

Here I use the model to predict the probabilities of being threatened for unlisted fish. The top five most vulnerable unranked species under this model are:

```{r}
#| echo: false
#| warning: false
tidy_pred_rank <- tidy_pred_rank %>% 
  select("genus_species", "length_cm", "coral_reefs", "main_common_name", "reef_associated", "endemic", "y_hat")
tab_df(tidy_pred_rank[1:5,],
       title = "Tbl 9. Most Vulnerable Unranked Fish",
       col.header = c("Genus species", "Length (cm)", "Reef Association",
                          "Common Name", "Reef Association", "Endemic",
                          "Threatened"))
```

<h3>Limitations & Next Steps</h3>

As mentioned above, both the IUCN Red List data and the FishBase data have potential biases and don't evaluate all species. Additionally, not all listed species had every piece of information, and missing data were removed. With missing data removed, the sample became small. It is possible that endemism plays a bigger role in threat risk than illustrated here by the model. Points of concern with this model include disproportionate data in both the threat level and endemism, and high false negative rates in binary prediction. Future analyses could investigate other potential explanatory variables such as metrics measuring fishing pressure, life cycle characteristics, and range. Additionally, future analyses could expand the area of interest to all of the tropics.

<h3>Reference</h3>

\[1\] "IUCN," IUCN Red List of Threatened Species. Version 2022-1, 2022. https://www.iucnredlist.org/ (accessed Dec. 02, 2022).

\[2\] B. J. Cardinale et al., "Biodiversity loss and its impact on humanity," Nature, vol. 486, no. 7401, Art. no. 7401, Jun. 2012, doi: 10.1038/nature11148. \[3\] M. J. Munstermann et al., "A global ecological signal of extinction risk in terrestrial vertebrates," Conserv. Biol., vol. 36, no. 3, p. e13852, 2022, doi: 10.1111/cobi.13852.

\[4\] "IUCN," IUCN Red List of Threatened Species. Version 2022-1, 2015. www.iucnredlist.org

\[5\] R. Froese and D. Pauly, "FishBase," 2022. www.fishbase.org

\[6\] C. Boettiger, D. Temple Lang, and P. Wainwright, "rfishbase: exploring, manipulating and visualizing FishBase data from R.," J. Fish Biol., 2012, doi: https://doi.org/10.1111/j.1095-8649.2012.03464.x.

\[7\] W. J. Ripple, C. Wolf, T. M. Newsome, M. Hoffmann, A. J. Wirsing, and D. J. McCauley, "Extinction risk is most acute for the world's largest and smallest vertebrates," Proc. Natl. Acad. Sci. U. S. A., vol. 114, no. 40, pp. 10678--10683, Oct. 2017, doi: 10.1073/pnas.1702078114.

\[8\] K. D. Bahr, P. L. Jokiel, and K. S. Rodgers, "The 2014 coral bleaching and freshwater flood events in Kāneʻohe Bay, Hawaiʻi," PeerJ, vol. 3, p. e1136, Aug. 2015, doi: 10.7717/peerj.1136.
